# See https://www.gitpod.io/docs/configure/workspaces/workspace-image
#image:
#  file: .devcontainer/Dockerfile.gitpod
# See https://www.gitpod.io/docs/configure/workspaces/ports
ports:
- name: temporal-web-ui
  description: The Web UI of Temporal
  port: 8080
  onOpen: ignore  # do not notify once the port is detected
- name: temporal-grpc
  description: The gRPC API of Temporal
  port: 7233
  onOpen: ignore  # do not notify once the port is detected
- name: temporal-http
  description: The HTTP API of Temporal
  port: 7243
  onOpen: ignore  # do not notify once the port is detected
- name: temporal-metrics
  description: The Prometheus endpoint to read Temporal metrics
  port: 9090
  onOpen: ignore  # do not notify once the port is detected
tasks:
- name: Server
  init: |
    TEMPORAL_CLI_VERSION=1.0.0
    PLATFORM=linux
    ARCHITECTURE=$(uname -m)

    case $ARCHITECTURE in \
        x86_64 | amd64) ARCHITECTURE=amd64 ;; \
        aarch64 | arm64) ARCHITECTURE=arm64 ;; \
        *) echo "Unsupported architecture: $ARCHITECTURE" && exit 1 ;; \
    esac

    curl -L "https://github.com/temporalio/cli/releases/download/v${TEMPORAL_CLI_VERSION}/temporal_cli_${TEMPORAL_CLI_VERSION}_${PLATFORM}_${ARCHITECTURE}.tar.gz" | \
      sudo tar -xz -C /usr/local/bin && \
      sudo chmod +x /usr/local/bin/temporal
      
    mkdir -p /tmp/logs
  command: |
    # Trigger start of temporal server, and send it to the background
    temporal server start-dev \
      --metrics-port 9090 \
      --ip 0.0.0.0 \
      --port 7233 \
      --http-port 7243 \
      --ui-port 8080 \
      | tee "/tmp/logs/temporal-server.log" \
      &
    # Wait for the web UI port to be open and open the preview
    gp ports await 8080 && \
      gp preview $(gp url 8080)/
    # Now wait on the temporal server process
    wait
- name: Worker
  init: |
    npm install
    mkdir -p /tmp/logs
  command: npm run start.watch | tee "/tmp/logs/temporal-worker.log"
  openMode: tab-after
- name: Terminal
  init: |
    echo Use 'npm run demo.0' to run a demo
  openMode: split-right